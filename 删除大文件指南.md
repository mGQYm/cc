# Git删除误上传大文件完整指南

## 问题描述
当Git仓库中包含超过GitHub 100MB限制的大文件时，会导致推送失败。常见的大文件包括：
- node_modules目录
- 二进制文件
- 压缩包
- 数据库文件
- 日志文件

## 方法一：删除特定大文件

### 1. 查找大文件
```bash
# 查找当前目录下大于50MB的文件
find . -type f -size +50M -exec ls -lh {} \;

# 查找Git历史中的大文件
git rev-list --objects --all | git cat-file --batch-check='%(objecttype) %(objectname) %(objectsize) %(rest)' | sed -n 's/^blob //p' | sort --numeric-sort --key=2 | tail -10
```

### 2. 删除特定文件
```bash
# 删除单个大文件
git filter-branch --force --index-filter \
'git rm --cached --ignore-unmatch 文件路径' \
--prune-empty --tag-name-filter cat -- --all

# 删除多个大文件
git filter-branch --force --index-filter \
'git rm --cached --ignore-unmatch 文件1 文件2 文件3' \
--prune-empty --tag-name-filter cat -- --all
```

## 方法二：删除整个目录

```bash
# 删除整个node_modules目录
git filter-branch --force --index-filter \
'git rm -r --cached --ignore-unmatch node_modules' \
--prune-empty --tag-name-filter cat -- --all

# 删除特定路径下的目录
git filter-branch --force --index-filter \
'git rm -r --cached --ignore-unmatch Web/travel/tripcraft/node_modules' \
--prune-empty --tag-name-filter cat -- --all
```

## 方法三：使用git filter-repo（推荐）

### 安装git filter-repo
```bash
# Ubuntu/Debian
sudo apt install git-filter-repo

# 或者使用pip
pip3 install git-filter-repo
```

### 使用filter-repo删除文件
```bash
# 删除特定文件
git filter-repo --path 文件路径 --invert-paths

# 删除整个目录
git filter-repo --path 目录路径 --invert-paths

# 删除多个文件/目录
git filter-repo --path 路径1 --path 路径2 --invert-paths
```

## 清理和推送

### 1. 清理引用（使用filter-branch后）
```bash
git for-each-ref --format='delete %(refname)' refs/original | git update-ref --stdin
```

### 2. 垃圾回收
```bash
git reflog expire --expire=now --all
git gc --prune=now --aggressive
```

### 3. 强制推送
```bash
git push origin master --force
```

## 预防措施

### 1. 完善.gitignore文件
```gitignore
# Node.js
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# 构建输出
dist/
build/
out/

# 日志文件
*.log
logs/

# 数据库文件
*.db
*.sqlite

# 压缩包
*.zip
*.tar.gz
*.rar

# 二进制文件
*.exe
*.dll
*.so
*.dylib

# 临时文件
*.tmp
*.temp
.DS_Store
Thumbs.db
```

### 2. 检查文件大小
```bash
# 在提交前检查文件大小
find . -type f -size +10M -exec ls -lh {} \;
```

### 3. 使用Git LFS
对于必须版本控制的大文件，使用Git Large File Storage：
```bash
# 安装Git LFS
git lfs install

# 跟踪大文件类型
git lfs track "*.psd"
git lfs track "*.zip"
git lfs track "*.mp4"

# 确保.gitattributes被提交
git add .gitattributes
```

## 注意事项

1. **备份重要数据**：在执行删除操作前，确保备份重要数据
2. **团队协作**：如果多人协作，需要通知团队成员重新克隆仓库
3. **历史记录**：删除操作会重写Git历史，所有提交的SHA都会改变
4. **强制推送**：删除后需要强制推送，会覆盖远程仓库历史

## 常见错误解决

### 错误：remote rejected
```bash
# 解决方案：强制推送
git push origin master --force
```

### 错误：refs/original still exists
```bash
# 解决方案：删除原始引用
git for-each-ref --format='delete %(refname)' refs/original | git update-ref --stdin
```

### 错误：pack too large
```bash
# 解决方案：增加Git缓冲区大小
git config --global http.postBuffer 524288000
git config --global http.maxRequestBuffer 100M
git config --global core.compression 9
```

## 总结

删除Git大文件的关键步骤：
1. 找到大文件
2. 使用filter-branch或filter-repo删除
3. 清理引用和垃圾回收
4. 强制推送
5. 完善.gitignore预防再次发生

记住：预防胜于治疗，合理配置.gitignore文件是避免大文件问题的最佳方法。
