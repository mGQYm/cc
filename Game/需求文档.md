# 开发需求文档

## 1. 需求文档 (PRD)

### 核心玩法
- 3层叠放的方块堆，每层随机分布不同图案
- 点击方块放入7格槽位，3个相同图案自动消除
- 槽位满时游戏失败，清除所有方块获胜
- 每日一关，固定种子确保所有玩家同一关卡

### 详细规则
- **方块叠放规则**：上层方块完全覆盖下层4个方块的1/4区域
- **可点击条件**：方块上方无任何遮挡（完全可见）
- **消除动画**：0.3秒缩放消失，上方方块自然下落
- **失败重试**：看广告获得一次"撤回"或"洗牌"机会

### 边界条件
- 最后3个方块图案不同时：游戏失败
- 槽位剩1格时：红色闪烁警告
- 网络断开：本地缓存进度，恢复后同步

## 2. 现有技术栈 & 约束

```javascript
// 当前项目结构
/src
  /components      // React组件
  /utils          // 工具函数
  /assets/sounds  // 音效文件
  /styles        // CSS模块

// 技术约束
- 框架：React 18 + TypeScript
- 状态管理：Zustand
- 动画：Framer Motion
- 构建：Vite
- 目标：移动端优先，支持微信小游戏
```

## 3. 测试用例

```typescript
describe('Game Logic Tests', () => {
  test('方块可点击状态判断', () => {
    // 场景：方块A上方有方块B部分覆盖
    // 期望：方块A不可点击
    const blockA = { x: 100, y: 100, width: 40, height: 40 }
    const blockB = { x: 110, y: 90, width: 40, height: 40 }
    expect(isClickable(blockA, [blockB])).toBe(false)
  })

  test('胜利条件检测', () => {
    // 场景：场上剩余0个方块
    // 期望：触发胜利动画
    game.removeAllBlocks()
    expect(checkWin()).toBe(true)
  })
})
```

## 4. 性能指标

- **首屏加载**：< 2秒（3G网络）
- **点击响应**：< 100ms
- **动画帧率**：> 50fps
- **内存占用**：< 50MB
- **安装包**：< 5MB

## 5. 用户交互时序图

```
用户点击方块
    ↓
检测是否可点击
    ↓
是 → 加入槽位 → 检测3个相同？
    ↓              ↓
否 → 抖动提示    是 → 消除动画
                否 → 检测槽位满？
                      ↓
                    是 → 游戏失败
                    否 → 继续游戏
```

## 6. 美术资源清单

### 必需资源
- **方块图案**：16种，每种3个，48x48px PNG
- **背景图**：750x1334px，分层PSD
- **音效**：点击音、消除音、胜利音、失败音
- **动画**：消除特效、方块下落、槽位警告

### 状态图
- 方块状态：默认、选中、不可点击、提示可消除
- UI状态：开始界面、游戏中、胜利、失败、暂停

## 7. 数据结构定义

```typescript
interface Block {
  id: string
  pattern: string // 'sheep' | 'grass' | 'barn' | ...
  position: { x: number; y: number; z: number }
  size: { width: number; height: number }
  isClickable: boolean
  layer: number // 0-2层
}

interface GameState {
  blocks: Block[]
  slot: Block[] // 最多7个
  score: number
  status: 'playing' | 'won' | 'lost' | 'paused'
  moves: number // 操作次数
}
```

## 8. 关卡配置示例

```json
{
  "level1": {
    "seed": 20240807,
    "layout": [
      {"pattern": "sheep", "x": 100, "y": 100, "z": 0},
      {"pattern": "grass", "x": 150, "y": 100, "z": 0},
      // ... 总共48个方块
    ],
    "solution": ["sheep", "grass", "barn"] // 可消除组合
  }
}
```

## 9. 微信小游戏适配

- **屏幕适配**：iPhone 6/7/8 Plus (414x736) 基准
- **触摸事件**：处理300ms延迟
- **分享功能**：生成战绩卡片
- **广告接入**：激励视频广告位

## 10. 异常处理

- **快速点击**：防抖处理，300ms内只响应一次
- **内存不足**：自动降低画质，关闭特效
- **网络异常**：本地存储进度，恢复后上传

## 11. 开发检查清单

### 必需功能
- [ ] 方块生成算法
- [ ] 点击检测逻辑
- [ ] 消除判定系统
- [ ] 胜利/失败条件
- [ ] 动画效果
- [ ] 音效播放

### 优化功能
- [ ] 撤回功能
- [ ] 洗牌功能
- [ ] 分享功能
- [ ] 排行榜
- [ ] 每日关卡

### 测试项目
- [ ] 单元测试覆盖率 > 80%
- [ ] 真机测试（iOS/Android）
- [ ] 性能测试
- [ ] 网络异常测试
- [ ] 内存泄漏检测

---

*文档版本：v1.0*
*最后更新：2024-08-07*